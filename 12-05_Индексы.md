# Домашнее задание к занятию «Индексы» - `Юрий Чеканов`

### Задание 1

Напишите запрос к учебной базе данных, который вернёт процентное отношение общего размера всех индексов к общему размеру всех таблиц.

```mysql
select table_schema, 
concat(round(sum(index_length)/(select sum(data_length) from INFORMATION_SCHEMA.tables where TABLE_SCHEMA='sakila')*100,2), '%') as 'Index share in DB volume'
from information_schema.tables
where TABLE_SCHEMA='sakila';
```

| TABLE_SCHEMA | Index share in DB volume |
| ------------ | ------------------------ |
| sakila       | 54.68%                   |

### Задание 2

Выполните explain analyze следующего запроса:

```mysql
select distinct concat(c.last_name, ' ', c.first_name), 
sum(p.amount) over (partition by c.customer_id, f.title)
from payment p, rental r, customer c, inventory i, film f
where date(p.payment_date) = '2005-07-30' and p.payment_date = r.rental_date and r.customer_id = c.customer_id and i.inventory_id = r.inventory_id
```
<details>
<summary>explain analyze</summary>
-> Table scan on <temporary>  (cost=2.50..2.50 rows=0) (actual time=11530.898..11531.025 rows=391 loops=1)
 <br>-> Temporary table with deduplication  (cost=0.00..0.00 rows=0) (actual time=11530.894..11530.894 rows=391 loops=1)
  <br>-> Window aggregate with buffering: sum(payment.amount) OVER (PARTITION BY c.customer_id,f.title )   (actual time=4759.954..11114.846 rows=642000 loops=1)
<br>-> Sort: c.customer_id, f.title  (actual time=4759.907..4914.797 rows=642000 loops=1)
<br>-> Stream results  (cost=10344602.65 rows=16005975) (actual time=0.670..3410.864 rows=642000 loops=1)
<br>-> Nested loop inner join  (cost=10344602.65 rows=16005975) (actual time=0.657..2883.577 rows=642000 loops=1)
<br>-> Nested loop inner join  (cost=8740003.64 rows=16005975) (actual time=0.650..2543.794 rows=642000 loops=1)
<br>-> Nested loop inner join  (cost=7135404.64 rows=16005975) (actual time=0.640..2176.383 rows=642000 loops=1)
<br>-> Inner hash join (no condition)  (cost=1581474.80 rows=15813000) (actual time=0.619..107.534 rows=634000 loops=1)
<br>-> Filter: (cast(p.payment_date as date) = '2005-07-30')  (cost=1.65 rows=15813) (actual time=0.057..14.821 rows=634 loops=1)
<br>-> Table scan on p  (cost=1.65 rows=15813) (actual time=0.038..9.296 rows=16044 loops=1)
<br>-> Hash
<br> -> Covering index scan on f using idx_title  (cost=103.00 rows=1000) (actual time=0.147..0.449 rows=1000 loops=1)
<br>-> Covering index lookup on r using rental_date (rental_date=p.payment_date)  (cost=0.25 rows=1) (actual time=0.002..0.003 rows=1 loops=634000)
<br>-> Single-row index lookup on c using PRIMARY (customer_id=r.customer_id)  (cost=0.00 rows=1) (actual time=0.000..0.000 rows=1 loops=642000)
<br>-> Single-row covering index lookup on i using PRIMARY (inventory_id=r.inventory_id)  (cost=0.00 rows=1) (actual time=0.000..0.000 rows=1 loops=642000)
 </details>


- перечислите узкие места;
  Убрать лишние таблицы **film** и **inventory** из запроса.

<details>
<summary>explain analyze</summary>
-> Limit: 200 row(s)  (cost=0.00..0.00 rows=0) (actual time=8.919..8.958 rows=200 loops=1)
<br>-> Table scan on <temporary>  (cost=2.50..2.50 rows=0) (actual time=8.917..8.944 rows=200 loops=1)
<br>-> Temporary table with deduplication  (cost=0.00..0.00 rows=0) (actual time=8.915..8.915 rows=391 loops=1)
<br>-> Window aggregate with buffering: sum(payment.amount) OVER (PARTITION BY c.customer_id )   (actual time=7.308..8.719 rows=642 loops=1)
<br>-> Sort: c.customer_id  (actual time=7.279..7.366 rows=642 loops=1)
<br>-> Stream results  (cost=12761.57 rows=16006) (actual time=0.077..7.117 rows=642 loops=1)
<br>-> Nested loop inner join  (cost=12761.57 rows=16006) (actual time=0.072..6.878 rows=642 loops=1)
<br>-> Nested loop inner join  (cost=7159.48 rows=16006) (actual time=0.066..6.309 rows=642 loops=1)
<br>-> Filter: (cast(p.payment_date as date) = '2005-07-30')  (cost=1605.55 rows=15813) (actual time=0.051..5.123 rows=634 loops=1)
<br>-> Table scan on p  (cost=1605.55 rows=15813) (actual time=0.040..3.867 rows=16044 loops=1)
<br>-> Covering index lookup on r using rental_date (rental_date=p.payment_date)  (cost=0.25 rows=1) (actual time=0.001..0.002 rows=1 loops=634)
<br>-> Single-row index lookup on c using PRIMARY (customer_id=r.customer_id)  (cost=0.25 rows=1) (actual time=0.001..0.001 rows=1 loops=642)
 </details>
- оптимизируйте запрос: внесите корректировки по использованию операторов, при необходимости добавьте индексы.

исправить код запроса на:

```mysql
select distinct concat(c.last_name, ' ', c.first_name), 
sum(p.amount) over (partition by c.customer_id)
from payment p
left join rental r on r.rental_id = p.rental_id 
left join customer c on c.customer_id = r.customer_id
where date(p.payment_date) = '2005-07-30'
```

<details>
<summary>explain analyze</summary>
<!--All you need is a blank line-->
-> Limit: 200 row(s)  (cost=0.00..0.00 rows=0) (actual time=8.043..8.092 rows=200 loops=1)
<br>-> Table scan on <temporary>  (cost=2.50..2.50 rows=0) (actual time=8.042..8.068 rows=200 loops=1)
<br>-> Temporary table with deduplication  (cost=0.00..0.00 rows=0) (actual time=8.040..8.040 rows=391 loops=1)
<br>-> Window aggregate with buffering: sum(payment.amount) OVER (PARTITION BY c.customer_id )   (actual time=7.053..7.868 rows=634 loops=1)
<br>-> Sort: c.customer_id  (actual time=7.028..7.066 rows=634 loops=1)
<br>-> Stream results  (cost=12674.65 rows=15813) (actual time=0.070..6.891 rows=634 loops=1)
<br>-> Nested loop left join  (cost=12674.65 rows=15813) (actual time=0.066..6.677 rows=634 loops=1)
<br>-> Nested loop left join  (cost=7140.10 rows=15813) (actual time=0.061..6.181 rows=634 loops=1)
<br>-> Filter: (cast(p.payment_date as date) = '2005-07-30')  (cost=1605.55 rows=15813) (actual time=0.051..5.403 rows=634 loops=1)
<br>-> Table scan on p  (cost=1605.55 rows=15813) (actual time=0.040..4.196 rows=16044 loops=1)
<br>-> Single-row index lookup on r using PRIMARY (rental_id=p.rental_id)  (cost=0.25 rows=1) (actual time=0.001..0.001 rows=1 loops=634)
<br>-> Single-row index lookup on c using PRIMARY (customer_id=r.customer_id)  (cost=0.25 rows=1) (actual time=0.001..0.001 rows=1 loops=634)
</details>


### Задание 3*

Самостоятельно изучите, какие типы индексов используются в PostgreSQL. Перечислите те индексы, которые используются в PostgreSQL, а в MySQL — нет.

*Приведите ответ в свободной форме.*



<details>
<summary>Heading</summary>
<!--All you need is a blank line-->
 <br>
</details>


 



