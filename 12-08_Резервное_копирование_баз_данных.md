# Домашнее задание к занятию «Резервное копирование баз данных» - `Юрий Чеканов`

### Задание 1. Резервное копирование

### Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

​	<u>Для данного ТЗ применимы следующие виды резервного копирования:</u>		

|          | Понед.    | Вторник                   | Среда                     | Четверг                   | Пятница                   | Суббота                   | Воскрес.                  | Комментарий                                                  |
| -------- | --------- | ------------------------- | ------------------------- | ------------------------- | ------------------------- | ------------------------- | ------------------------- | ------------------------------------------------------------ |
| Вариант1 | Full Back | Full Back                 | Full Back                 | Full Back                 | Full Back                 | Full Back                 | Full Back                 | Очень накладный и  нерациональный способ резервирования      |
| Вариант2 | Full Back | Incremental       Backup  | Incremental       Backup  | Incremental       Backup  | Incremental       Backup  | Incremental       Backup  | Incremental       Backup  | высокая  скорость резервного копирования ,     меньше места для хранения,     большее количество точек восстановления,  для восстановления файлов потребуется последний     созданный полный бэкап и все инкрементные бэкапы от полного бэкапа до точки восстановления. |
| Вариант3 | Full Back | Differential       Backup | Differential       Backup | Differential       Backup | Differential       Backup | Differential       Backup | Differential       Backup | Относительно  небольшой размер разностной резервной     копии,      скорость создания в разы выше, чем полного бэкапа,     для восстановления файлов потребуется последний     созданный полный бэкап и последний дифференциальный. |

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

​	<u>Для данного ТЗ применимы следующие виды резервного копирования:</u>	

- Горячий бэкап - mysqldump, mysqlhotcopy, Percona XtraBackup
- Резервирование средствами LVM  - снятие образа диска без остановки системы (метод подразумевает кратковременную блокировку таблиц). БД должна располагаться на выделенном LVM томе. 
- Репликация - master-slave или/и DRBD. В первом случае данные реплицируются средствами БД, во втором за счет репликации блочного устройства (ВАЖНО убедиться, что состояние сети с использованием DRBD для синхронизации достаточно хорошее. DRBD = высокая нагрузка сети при значительных объемах данных для синхронизации.)	

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

<u>MySQL master-slave + DRBD + heartbeat + LVS:</u>

- Heartbeat + DRBD -  высокая доступность операций записи главного узла MySQL
- MySQL master-slave + LVS - репликация и балансировка. 

<u>Useful links:</u>

[Модели восстановления](https://habr.com/ru/articles/327606/)	[Модели восстановления 2](https://sql-ex.ru/blogs/?/Ponimanie_modelej_vosstanovleniJa_SQL_Server.html)	[Средства создания горячих BackUp`ов MySQL](https://habr.com/ru/articles/63394/)	[Use XtraBackup](https://habr.com/ru/articles/520458/)	[Use XtraBackup 2](https://habr.com/ru/companies/first/articles/582230/)

[Обеспечение сохранности данных в MySql](https://studfile.net/preview/3707291/page:47/)	[HA cluster MySQL + heartbeat + DRBD + LVS](https://russianblogs.com/article/75081356586/)

------

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

<u>Assume we have dumped a database called `mydb` into a custom-format dump file:</u>

```
$ pg_dump -Fc mydb > db.dump
```

<u>To drop the database and recreate it from the dump:</u>

```
$ dropdb mydb
$ pg_restore -C -d postgres db.dump
```

[Documentation postgresql](https://www.postgresql.org/docs/current/app-pgrestore.html)

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

​		Резервирование данных можно автоматизировать с помощью  шедулера pgAgent, входящего в состав ПО для управления postgresql - pgadmin.

​		[pgadmin](https://www.pgadmin.org)

​		[Автоматизация pg_dump с помощью pgAgent](https://www.digitalocean.com/community/tutorials/how-to-schedule-automatic-backups-for-postgresql-with-pgagent-in-pgadmin)

------

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

​	В примере используется параметр --incremental-base=history:last_backup., учитывается что mysqlbackup извлекает LSN последней успешной (не TTS) полной или частичной резервной копии из таблицы mysql.backup_history и на ее основе выполняется инкрементное резервное копирование.

```mysql
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```

​		В этом примере выполняется инкрементное резервное копирование, подобное тому, что было в предыдущем примере, но с параметром   --incremental=optimistic сканируется только измененные страницы в файлах данных InnoDB, которые были изменены с момента последней резервной копии. Для данного вида резервирования важно чтобы оставались неизменными со времени предыдущего резервного копирования системное время на сервере и расположение каталога данных. В противном случае может произойти сбой резервного копирования или может быть создана несогласованная добавочная резервная копия.

```mysql
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental=optimistic --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi 
   backup-to-image
```

[MySQL documentation](https://dev.mysql.com/doc/mysql-enterprise-backup/8.0/en/mysqlbackup.incremental.html)

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

​	Как я понимаю нельзя противопоставлять репликацию резервному копированию и наоборот. Оба метода могут использоваться параллельно. 

Репликация это больше про отказоустойчивость и доступность, резервное копирование про сохранность данных. 

Т.о. в тех случаях когда нам важно обеспечить непрерывность и высокую доступность будет предпочтительна репликация, но это не отменяет резервное копирование данных. 

|                       | Резервное копирование                                        | Репликация                                                   |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Стоимость             | Низкая стоимость по сравнению с репликацией. Не требует значительных инвестиций в персонал или инфраструктуру. | Дороже, чем резервное копирование. Готовые коммерческие платформы и решения могут помочь снизить затраты. |
| Требования            | Локальный диск, виртуальная ленточная библиотека или онлайн-сервис резервного копирования. Дискретное хранилище для архивных данных. | Внедрение новых бизнес-процессов, дополнительный персонал и инвестиции в инфраструктуру. |
| Идеально подходит для | Долгосрочное хранение данных и требования, связанные с соблюдением нормативных требований. | Обеспечение непрерывного доступа к критически важным приложениям и приложениям, ориентированным на клиентов. |
| Преимущества          | - Простота внедрения. - Высокий уровень изоляции от потенциальных угроз. - Недорого. | - Фокус на аварийном восстановлении. - Высокая доступность. - Быстрое возобновление бизнес-операций после сбоя. |
| Недостатки            | - Значительный промежуток времени между резервными копиями. - Длительный процесс восстановления данных. | - Дорогостоящее обслуживание (особенно при длительном хранении). - Вредоносное программное обеспечение может распространяться на реплицированные данные. |

 